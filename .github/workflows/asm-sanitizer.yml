name: asm-sanitizer

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1"

jobs:
  sanitizer:
    runs-on: ubuntu-latest
    env:
      ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
      LSAN_OPTIONS: print_suppressions=0
      RUSTFLAGS: -Zsanitizer=address
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Run crypto-accel tests under ASAN/LSAN
        run: cargo test -p crypto-accel

      - name: Run asm symbol audit
        run: ./scripts/run_asm_symbol_audit_ci.sh
