name: Build Threat Intel Bundle

on:
  schedule:
    - cron: "30 4 * * *"  # Daily at 04:30 UTC (after all collectors finish)
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install yara-python pyyaml

      - name: Install zstd
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Set version
        id: version
        run: echo "version=$(date -u +%Y.%m.%d.%H%M)" >> "$GITHUB_OUTPUT"

      - name: Download latest collector artifacts
        run: |
          mkdir -p /tmp/artifacts
          # Download latest artifacts from each collector workflow
          for name in sigma-filtered yara-collected ioc-curated cve-extracted; do
            echo "Downloading artifact: $name"
            gh run download --repo "$GITHUB_REPOSITORY" \
              --name "$name" --dir "/tmp/artifacts/$name" 2>/dev/null || \
              echo "  Warning: artifact $name not found (collector may not have run yet)"
          done
          echo "Artifacts downloaded:"
          find /tmp/artifacts -type f | head -20
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate YARA rules
        run: |
          mkdir -p /tmp/yara_validated
          YARA_DIR="/tmp/artifacts/yara-collected"
          if [ -d "$YARA_DIR" ] && [ "$(find "$YARA_DIR" -name '*.yar' -o -name '*.yara' 2>/dev/null | head -1)" ]; then
            python threat-intel/processing/yara_validate.py \
              --input "$YARA_DIR" \
              --output /tmp/yara_validated \
              --test-files threat-intel/tests/clean_files
          else
            echo "No YARA rules to validate"
          fi

      - name: Prepare IOC files
        run: |
          mkdir -p /tmp/ioc_ready
          IOC_DIR="/tmp/artifacts/ioc-curated"
          if [ -d "$IOC_DIR" ]; then
            cp "$IOC_DIR"/*.txt /tmp/ioc_ready/ 2>/dev/null || true
          fi

      - name: Build bundle
        run: |
          python threat-intel/processing/build_bundle.py \
            --sigma /tmp/artifacts/sigma-filtered \
            --yara /tmp/yara_validated \
            --ioc /tmp/ioc_ready \
            --cve /tmp/artifacts/cve-extracted/cves.jsonl \
            --output bundle \
            --version "${{ steps.version.outputs.version }}"

      - name: Package bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE="eguard-rules-${VERSION}.bundle.tar.zst"

          if [ -z "${THREAT_INTEL_ED25519_PRIVATE_KEY_PEM:-}" ]; then
            echo "Missing THREAT_INTEL_ED25519_PRIVATE_KEY_PEM secret"
            exit 1
          fi

          tar cf - -C bundle/ . | zstd -3 -o "${BUNDLE}"
          python threat-intel/processing/ed25519_sign.py \
            --input "${BUNDLE}" \
            --output-sig "${BUNDLE}.sig" \
            --public-key-hex-out "${BUNDLE}.pub.hex"

          TMP_KEY="$(mktemp /tmp/eguard-ed25519-key.XXXXXX.pem)"
          TMP_PUB="$(mktemp /tmp/eguard-ed25519-pub.XXXXXX.pem)"
          trap 'rm -f "${TMP_KEY}" "${TMP_PUB}"' EXIT
          printf '%s\n' "${THREAT_INTEL_ED25519_PRIVATE_KEY_PEM}" > "${TMP_KEY}"
          openssl pkey -in "${TMP_KEY}" -pubout -out "${TMP_PUB}"
          python threat-intel/processing/ed25519_verify.py \
            --input "${BUNDLE}" \
            --signature "${BUNDLE}.sig" \
            --public-key-file "${TMP_PUB}"

          echo "Bundle size: $(du -sh "${BUNDLE}" | cut -f1)"
        env:
          THREAT_INTEL_ED25519_PRIVATE_KEY_PEM: ${{ secrets.THREAT_INTEL_ED25519_PRIVATE_KEY_PEM }}

      - name: Create GitHub Release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE="eguard-rules-${VERSION}.bundle.tar.zst"
          python3 -c "
          import json
          m = json.load(open('bundle/manifest.json'))
          lines = [
              'Automated threat intelligence bundle.',
              '',
              f'- SIGMA rules: {m[\"sigma_count\"]}',
              f'- YARA rules: {m[\"yara_count\"]}',
              f'- IOC hashes: {m[\"ioc_hash_count\"]}',
              f'- IOC domains: {m[\"ioc_domain_count\"]}',
              f'- IOC IPs: {m[\"ioc_ip_count\"]}',
              f'- CVEs: {m[\"cve_count\"]}',
          ]
          open('/tmp/release_notes.md', 'w').write('\n'.join(lines))
          "
          gh release create "rules-${VERSION}" \
            "${BUNDLE}" \
            "${BUNDLE}.sig" \
            "${BUNDLE}.pub.hex" \
            --title "Rule Bundle ${VERSION}" \
            --notes-file /tmp/release_notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
