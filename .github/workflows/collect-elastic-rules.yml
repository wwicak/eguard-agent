name: Collect Elastic Detection Rules

on:
  schedule:
    - cron: "15 2 * * *"  # Daily at 02:15 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: collect-elastic-rules-${{ github.ref }}
  cancel-in-progress: true

jobs:
  collect-elastic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Elastic detection-rules ────────────────────────────────────
      # 700+ detection rules from Elastic Security's Threat Research
      # team. TOML format with KQL/EQL queries. We extract Linux and
      # cross-platform rules as behavioral detection patterns.
      # Elastic License 2.0.
      - name: Clone Elastic detection-rules
        run: |
          git clone --depth 1 --filter=blob:none --sparse \
            https://github.com/elastic/detection-rules.git /tmp/elastic-rules
          cd /tmp/elastic-rules && git sparse-checkout set rules rules_building_block

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install toml parser
        run: pip install tomli

      # Extract Linux and cross-platform rules, convert to JSON
      # for easier consumption by eGuard detection engine.
      - name: Filter and extract Linux rules
        run: |
          python3 threat-intel/processing/elastic_extract.py \
            --input /tmp/elastic-rules/rules \
            --building-blocks /tmp/elastic-rules/rules_building_block \
            --output /tmp/elastic_filtered \
            --platforms linux cross-platform

      - name: Enforce Elastic collector coverage
        env:
          EGUARD_MIN_ELASTIC_RULES: "100"
        run: |
          python3 - <<'PY'
          import json
          import os
          import pathlib
          import sys

          root = pathlib.Path('/tmp/elastic_filtered')
          jsonl = root / 'elastic-rules.jsonl'
          index = root / 'index.json'
          minimum = int(os.environ.get('EGUARD_MIN_ELASTIC_RULES', '100'))

          if not jsonl.is_file():
              print('elastic collector coverage gate failed: missing elastic-rules.jsonl')
              sys.exit(1)

          rule_count = sum(1 for line in jsonl.read_text(encoding='utf-8').splitlines() if line.strip())
          print(f'elastic extracted rules: {rule_count}')

          if index.is_file():
              idx = json.loads(index.read_text(encoding='utf-8'))
              print(f'elastic severity breakdown: {idx.get("severity_breakdown", {})}')

          if rule_count < minimum:
              print(f'elastic collector coverage gate failed: {rule_count} < {minimum}')
              sys.exit(1)

          print('elastic collector coverage gate passed')
          PY

      - name: Upload Elastic rules as artifact
        uses: actions/upload-artifact@v4
        with:
          name: elastic-rules
          path: /tmp/elastic_filtered/
          retention-days: 7
