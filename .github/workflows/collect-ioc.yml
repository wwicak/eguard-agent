name: Collect IOC Feeds

on:
  schedule:
    - cron: "0 */4 * * *"  # Every 4 hours
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: collect-ioc-${{ github.ref }}
  cancel-in-progress: true

jobs:
  collect-ioc:
    runs-on: ubuntu-latest
    env:
      MALWARE_BAZAAR_KEY: ${{ secrets.MALWARE_BAZAAR_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create source directories
        run: mkdir -p sources/ioc/{hashes,domains,ips}

      # ────────────────────────────────────────────────────────────────
      # Tier 1: Government / Premium Blocklists (highest confidence)
      # ────────────────────────────────────────────────────────────────

      - name: "Fetch Spamhaus DROP + EDROP (Tier 1)"
        run: |
          # DROP: most conservative, zero false-positive IP blocklist
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.spamhaus.org/drop/drop.txt" \
            -o /tmp/spamhaus_drop.txt 2>/dev/null || true
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.spamhaus.org/drop/edrop.txt" \
            -o /tmp/spamhaus_edrop.txt 2>/dev/null || true
          {
            grep -v '^;' /tmp/spamhaus_drop.txt 2>/dev/null | awk '{print $1}' | grep -E '^[0-9]'
            grep -v '^;' /tmp/spamhaus_edrop.txt 2>/dev/null | awk '{print $1}' | grep -E '^[0-9]'
          } | sort -u > sources/ioc/ips/spamhaus.txt
          echo "Spamhaus DROP+EDROP: $(wc -l < sources/ioc/ips/spamhaus.txt) entries"

      - name: "Fetch FireHOL Level 1 (Tier 1)"
        run: |
          # Aggregated from DShield, Spamhaus, blocklist.de, etc. — highest confidence tier
          curl -sSfL --retry 3 --max-time 120 \
            "https://raw.githubusercontent.com/firehol/blocklist-ipsets/master/firehol_level1.netset" \
            -o /tmp/firehol.txt 2>/dev/null || true
          if [ -s /tmp/firehol.txt ]; then
            grep -v '^#' /tmp/firehol.txt | grep -v '^$' | sort -u > sources/ioc/ips/firehol_l1.txt
            echo "FireHOL L1: $(wc -l < sources/ioc/ips/firehol_l1.txt) entries"
          fi

      # ────────────────────────────────────────────────────────────────
      # Tier 2: Community-Vetted Sources (abuse.ch, SANS, DigitalSide)
      # ────────────────────────────────────────────────────────────────

      - name: "Fetch MalwareBazaar hashes (Tier 2 — abuse.ch)"
        run: |
          curl -sSfL --retry 3 --max-time 120 \
            "https://bazaar.abuse.ch/export/txt/sha256/recent/" \
            -o /tmp/bazaar_hashes.txt
          grep -v '^#' /tmp/bazaar_hashes.txt | grep -v '^$' | \
            awk '{print $1}' > /tmp/bazaar_export_hashes.txt

          if [ -n "${MALWARE_BAZAAR_KEY:-}" ]; then
            python - <<'PY'
import json
import os
import sys
import urllib.parse
import urllib.request

key = os.getenv("MALWARE_BAZAAR_KEY", "").strip()
if not key:
    sys.exit(0)

payload = urllib.parse.urlencode({"query": "get_recent", "selector": "100"}).encode()
req = urllib.request.Request(
    "https://mb-api.abuse.ch/api/v1/",
    data=payload,
    headers={"Auth-Key": key},
)

try:
    with urllib.request.urlopen(req, timeout=60) as resp:
        raw = resp.read().decode("utf-8", "ignore")
except Exception as exc:
    print(f"MalwareBazaar API fetch failed: {exc}")
    sys.exit(0)

try:
    doc = json.loads(raw)
except Exception as exc:
    print(f"MalwareBazaar API JSON parse failed: {exc}")
    sys.exit(0)

if doc.get("query_status") != "ok":
    print(f"MalwareBazaar API query_status={doc.get('query_status')}")
    sys.exit(0)

hashes = [item.get("sha256_hash") for item in doc.get("data", []) if item.get("sha256_hash")]
with open("/tmp/bazaar_api_hashes.txt", "w", encoding="utf-8") as handle:
    for value in hashes:
        handle.write(f"{value}\n")
print(f"MalwareBazaar API hashes: {len(hashes)}")
PY
          fi

          if [ -s /tmp/bazaar_api_hashes.txt ]; then
            cat /tmp/bazaar_export_hashes.txt /tmp/bazaar_api_hashes.txt | sort -u > sources/ioc/hashes/malwarebazaar.txt
          else
            cp /tmp/bazaar_export_hashes.txt sources/ioc/hashes/malwarebazaar.txt
          fi

          echo "MalwareBazaar hashes: $(wc -l < sources/ioc/hashes/malwarebazaar.txt)"

      - name: "Fetch ThreatFox IOCs (Tier 2 — abuse.ch)"
        run: |
          curl -sSfL --retry 3 --max-time 120 \
            "https://threatfox.abuse.ch/export/csv/recent/" \
            -o /tmp/threatfox.csv
          grep -v '^#' /tmp/threatfox.csv | grep -v '^$' | \
            awk -F'","' '{
              type=$5; ioc=$6;
              gsub(/"/, "", type); gsub(/"/, "", ioc);
              if (type ~ /domain/) print ioc;
            }' | sort -u > sources/ioc/domains/threatfox.txt
          grep -v '^#' /tmp/threatfox.csv | grep -v '^$' | \
            awk -F'","' '{
              type=$5; ioc=$6;
              gsub(/"/, "", type); gsub(/"/, "", ioc);
              if (type ~ /ip/) { split(ioc, a, ":"); print a[1]; }
            }' | sort -u > sources/ioc/ips/threatfox.txt
          # Also extract SHA-256 hashes from ThreatFox
          grep -v '^#' /tmp/threatfox.csv | grep -v '^$' | \
            awk -F'","' '{
              type=$5; ioc=$6;
              gsub(/"/, "", type); gsub(/"/, "", ioc);
              if (type ~ /sha256/) print ioc;
            }' | sort -u > sources/ioc/hashes/threatfox.txt

      - name: "Fetch Feodo C2 IPs (Tier 2 — abuse.ch)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://feodotracker.abuse.ch/downloads/ipblocklist_aggressive.txt" \
            -o /tmp/feodo.txt
          grep -v '^#' /tmp/feodo.txt | grep -v '^$' | \
            sort -u > sources/ioc/ips/feodo.txt
          echo "Feodo C2 IPs: $(wc -l < sources/ioc/ips/feodo.txt)"

      - name: "Fetch URLhaus domains (Tier 2 — abuse.ch)"
        run: |
          curl -sSfL --retry 3 --max-time 120 \
            "https://urlhaus.abuse.ch/downloads/text_online/" \
            -o /tmp/urlhaus.txt
          grep -v '^#' /tmp/urlhaus.txt | grep -v '^$' | \
            sed 's|https\?://||; s|/.*||; s|:.*||' | \
            sort -u > sources/ioc/domains/urlhaus.txt

      - name: "Fetch SSL Blacklist (Tier 2 — abuse.ch)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://sslbl.abuse.ch/blacklist/sslipblacklist_aggressive.csv" \
            -o /tmp/sslbl.csv
          grep -v '^#' /tmp/sslbl.csv | grep -v '^$' | \
            awk -F, '{print $1}' | grep -E '^[0-9]' | \
            sort -u > sources/ioc/ips/sslbl.txt
          echo "SSL Blacklist IPs: $(wc -l < sources/ioc/ips/sslbl.txt)"
          # Also extract SHA1 fingerprints as supplementary hashes
          grep -v '^#' /tmp/sslbl.csv | grep -v '^$' | \
            awk -F, '{print $2}' | grep -E '^[0-9a-f]{40}$' | \
            sort -u > sources/ioc/hashes/sslbl_sha1.txt

      - name: "Fetch DShield top attackers (Tier 2 — SANS ISC)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.dshield.org/block.txt" \
            -o /tmp/dshield.txt 2>/dev/null || true
          if [ -s /tmp/dshield.txt ]; then
            # Format: Start_IP\tEnd_IP\tAttacks\tName...
            awk '/^[0-9]/ {print $1}' /tmp/dshield.txt | sort -u > sources/ioc/ips/dshield.txt
            echo "DShield IPs: $(wc -l < sources/ioc/ips/dshield.txt)"
          fi

      - name: "Fetch DigitalSide OSINT (Tier 2)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://osint.digitalside.it/Threat-Intel/lists/latestips.txt" \
            -o /tmp/digitalside_ips.txt 2>/dev/null || true
          curl -sSfL --retry 3 --max-time 60 \
            "https://osint.digitalside.it/Threat-Intel/lists/latestdomains.txt" \
            -o /tmp/digitalside_domains.txt 2>/dev/null || true
          if [ -s /tmp/digitalside_ips.txt ]; then
            grep -v '^#' /tmp/digitalside_ips.txt | grep -v '^$' | sort -u > sources/ioc/ips/digitalside.txt
            echo "DigitalSide IPs: $(wc -l < sources/ioc/ips/digitalside.txt)"
          fi
          if [ -s /tmp/digitalside_domains.txt ]; then
            grep -v '^#' /tmp/digitalside_domains.txt | grep -v '^$' | sort -u > sources/ioc/domains/digitalside.txt
            echo "DigitalSide domains: $(wc -l < sources/ioc/domains/digitalside.txt)"
          fi

      # ────────────────────────────────────────────────────────────────
      # Tier 3: Community / Aggregator Sources
      # ────────────────────────────────────────────────────────────────

      - name: "Fetch Botvrij.eu IOCs (Tier 3)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.botvrij.eu/data/ioclist.domain.raw" \
            -o /tmp/botvrij_domains.txt 2>/dev/null || true
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.botvrij.eu/data/ioclist.ip-dst.raw" \
            -o /tmp/botvrij_ips.txt 2>/dev/null || true
          if [ -s /tmp/botvrij_domains.txt ]; then
            grep -v '^#' /tmp/botvrij_domains.txt | grep -v '^$' | sort -u > sources/ioc/domains/botvrij.txt
          fi
          if [ -s /tmp/botvrij_ips.txt ]; then
            grep -v '^#' /tmp/botvrij_ips.txt | grep -v '^$' | sort -u > sources/ioc/ips/botvrij.txt
          fi

      - name: "Fetch CINSscore threat IPs (Tier 3)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://cinsscore.com/list/ci-badguys.txt" \
            -o /tmp/cins.txt 2>/dev/null || true
          if [ -s /tmp/cins.txt ]; then
            grep -v '^#' /tmp/cins.txt | grep -v '^$' | sort -u > sources/ioc/ips/cins.txt
            echo "CINS IPs: $(wc -l < sources/ioc/ips/cins.txt)"
          fi

      - name: "Fetch Blocklist.de (Tier 3)"
        run: |
          curl -sSfL --retry 3 --max-time 60 \
            "https://lists.blocklist.de/lists/all.txt" \
            -o /tmp/blocklist_de.txt 2>/dev/null || true
          if [ -s /tmp/blocklist_de.txt ]; then
            grep -v '^#' /tmp/blocklist_de.txt | grep -v '^$' | sort -u > sources/ioc/ips/blocklist_de.txt
            echo "Blocklist.de IPs: $(wc -l < sources/ioc/ips/blocklist_de.txt)"
          fi

      - name: "Fetch AlienVault OTX (Tier 3 — optional)"
        if: ${{ env.OTX_API_KEY != '' }}
        env:
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}
        run: |
          curl -sSfL --retry 3 --max-time 120 \
            -H "X-OTX-API-KEY: ${OTX_API_KEY}" \
            "https://otx.alienvault.com/api/v1/pulses/subscribed?modified_since=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%S)" \
            -o /tmp/otx_pulses.json
          python3 -c "
          import json, sys
          data = json.load(open('/tmp/otx_pulses.json'))
          hashes, domains, ips = set(), set(), set()
          for pulse in data.get('results', []):
              for ind in pulse.get('indicators', []):
                  t = ind.get('type', '')
                  v = ind.get('indicator', '')
                  if t in ('FileHash-SHA256',): hashes.add(v)
                  elif t in ('domain', 'hostname'): domains.add(v)
                  elif t in ('IPv4',): ips.add(v)
          open('sources/ioc/hashes/otx.txt', 'w').write('\n'.join(sorted(hashes)))
          open('sources/ioc/domains/otx.txt', 'w').write('\n'.join(sorted(domains)))
          open('sources/ioc/ips/otx.txt', 'w').write('\n'.join(sorted(ips)))
          "

      # ────────────────────────────────────────────────────────────────
      # Dedup, corroborate, and allowlist
      # ────────────────────────────────────────────────────────────────

      - name: Deduplicate and corroborate IOCs
        run: |
          python threat-intel/processing/ioc_dedup.py \
            --input sources/ioc \
            --output /tmp/ioc_deduped

      - name: Apply allowlists
        run: |
          python threat-intel/processing/ioc_allowlist.py \
            --input /tmp/ioc_deduped \
            --output sources/ioc/consolidated \
            --hash-allowlist threat-intel/allowlists/known_good_hashes.txt \
            --domain-allowlist threat-intel/allowlists/known_good_domains.txt \
            --ip-allowlist threat-intel/allowlists/known_good_ips.txt

      - name: Enforce IOC collector coverage
        env:
          EGUARD_MIN_IOC_HASH: "1000"
          EGUARD_MIN_IOC_DOMAIN: "300"
          EGUARD_MIN_IOC_IP: "1500"
        run: |
          HASH_COUNT=$(wc -l < sources/ioc/consolidated/hashes.txt 2>/dev/null || echo 0)
          DOMAIN_COUNT=$(wc -l < sources/ioc/consolidated/domains.txt 2>/dev/null || echo 0)
          IP_COUNT=$(wc -l < sources/ioc/consolidated/ips.txt 2>/dev/null || echo 0)

          echo "IOC hashes: ${HASH_COUNT}"
          echo "IOC domains: ${DOMAIN_COUNT}"
          echo "IOC IPs: ${IP_COUNT}"

          if [ "${HASH_COUNT}" -lt "${EGUARD_MIN_IOC_HASH}" ]; then
            echo "IOC collector coverage gate failed: hashes ${HASH_COUNT} < ${EGUARD_MIN_IOC_HASH}"
            exit 1
          fi
          if [ "${DOMAIN_COUNT}" -lt "${EGUARD_MIN_IOC_DOMAIN}" ]; then
            echo "IOC collector coverage gate failed: domains ${DOMAIN_COUNT} < ${EGUARD_MIN_IOC_DOMAIN}"
            exit 1
          fi
          if [ "${IP_COUNT}" -lt "${EGUARD_MIN_IOC_IP}" ]; then
            echo "IOC collector coverage gate failed: ips ${IP_COUNT} < ${EGUARD_MIN_IOC_IP}"
            exit 1
          fi

          echo "IOC collector coverage gate passed"

      - name: Upload curated IOCs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ioc-curated
          path: sources/ioc/consolidated/
          retention-days: 7
