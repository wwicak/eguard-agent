name: Collect IOC Feeds

on:
  schedule:
    - cron: "0 */4 * * *"  # Every 4 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect-ioc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Create source directories
        run: mkdir -p sources/ioc/{hashes,domains,ips}

      - name: Fetch MalwareBazaar hashes (abuse.ch)
        run: |
          # Full hash list (~1M entries, ZIP archive)
          curl -sSfL --retry 3 --max-time 300 \
            "https://bazaar.abuse.ch/export/txt/sha256/full/" \
            -o /tmp/bazaar_full.zip
          python3 -c "import zipfile; zipfile.ZipFile('/tmp/bazaar_full.zip').extractall('/tmp/bazaar_extract')"
          grep -v '^#' /tmp/bazaar_extract/full_sha256.txt | grep -v '^$' | \
            awk '{print $1}' > sources/ioc/hashes/malwarebazaar.txt
          echo "MalwareBazaar hashes: $(wc -l < sources/ioc/hashes/malwarebazaar.txt)"

      - name: Fetch ThreatFox IOCs (abuse.ch)
        run: |
          # Full export covers all known IOCs, not just recent
          curl -sSfL --retry 3 --max-time 300 \
            "https://threatfox.abuse.ch/export/csv/full/" \
            -o /tmp/threatfox.csv.zip
          python3 -c "import zipfile; zipfile.ZipFile('/tmp/threatfox.csv.zip').extractall('/tmp/threatfox_dir')"
          cat /tmp/threatfox_dir/*.csv > /tmp/threatfox.csv 2>/dev/null || mv /tmp/threatfox_dir/* /tmp/threatfox.csv
          # Extract domains and IPs from ThreatFox CSV
          grep -v '^#' /tmp/threatfox.csv | grep -v '^$' | \
            awk -F'","' '{
              type=$5; ioc=$6;
              gsub(/"/, "", type); gsub(/"/, "", ioc);
              if (type ~ /domain/) print ioc;
            }' | sort -u > sources/ioc/domains/threatfox.txt
          grep -v '^#' /tmp/threatfox.csv | grep -v '^$' | \
            awk -F'","' '{
              type=$5; ioc=$6;
              gsub(/"/, "", type); gsub(/"/, "", ioc);
              if (type ~ /ip/) { split(ioc, a, ":"); print a[1]; }
            }' | sort -u > sources/ioc/ips/threatfox.txt

      - name: Fetch Feodo C2 IPs (abuse.ch)
        run: |
          # Aggressive blocklist (~7k IPs, includes historical C2 infrastructure)
          curl -sSfL --retry 3 --max-time 60 \
            "https://feodotracker.abuse.ch/downloads/ipblocklist_aggressive.txt" \
            -o /tmp/feodo.txt
          grep -v '^#' /tmp/feodo.txt | grep -v '^$' | \
            sort -u > sources/ioc/ips/feodo.txt
          echo "Feodo C2 IPs: $(wc -l < sources/ioc/ips/feodo.txt)"

      - name: Fetch URLhaus domains (abuse.ch)
        run: |
          curl -sSfL --retry 3 --max-time 120 \
            "https://urlhaus.abuse.ch/downloads/text_online/" \
            -o /tmp/urlhaus.txt
          # Extract domains from URLs
          grep -v '^#' /tmp/urlhaus.txt | grep -v '^$' | \
            sed 's|https\?://||; s|/.*||; s|:.*||' | \
            sort -u > sources/ioc/domains/urlhaus.txt

      - name: Fetch SSL Blacklist (abuse.ch)
        run: |
          # Malicious SSL certificate fingerprints (SHA-1)
          curl -sSfL --retry 3 --max-time 60 \
            "https://sslbl.abuse.ch/blacklist/sslipblacklist_aggressive.csv" \
            -o /tmp/sslbl.csv
          grep -v '^#' /tmp/sslbl.csv | grep -v '^$' | \
            awk -F, '{print $1}' | grep -E '^[0-9]' | \
            sort -u > sources/ioc/ips/sslbl.txt
          echo "SSL Blacklist IPs: $(wc -l < sources/ioc/ips/sslbl.txt)"

      - name: Fetch Botvrij.eu IOCs
        run: |
          # European CERT-curated IOCs
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.botvrij.eu/data/ioclist.domain.raw" \
            -o /tmp/botvrij_domains.txt 2>/dev/null || true
          curl -sSfL --retry 3 --max-time 60 \
            "https://www.botvrij.eu/data/ioclist.ip-dst.raw" \
            -o /tmp/botvrij_ips.txt 2>/dev/null || true
          if [ -s /tmp/botvrij_domains.txt ]; then
            grep -v '^#' /tmp/botvrij_domains.txt | grep -v '^$' | sort -u > sources/ioc/domains/botvrij.txt
          fi
          if [ -s /tmp/botvrij_ips.txt ]; then
            grep -v '^#' /tmp/botvrij_ips.txt | grep -v '^$' | sort -u > sources/ioc/ips/botvrij.txt
          fi

      - name: Fetch CINSscore threat IPs
        run: |
          # CINS (Collective Intelligence Network Security) threat IPs
          curl -sSfL --retry 3 --max-time 60 \
            "https://cinsscore.com/list/ci-badguys.txt" \
            -o /tmp/cins.txt 2>/dev/null || true
          if [ -s /tmp/cins.txt ]; then
            grep -v '^#' /tmp/cins.txt | grep -v '^$' | sort -u > sources/ioc/ips/cins.txt
            echo "CINS IPs: $(wc -l < sources/ioc/ips/cins.txt)"
          fi

      - name: Fetch Blocklist.de
        run: |
          # Community-driven IDS/IPS blocklist
          curl -sSfL --retry 3 --max-time 60 \
            "https://lists.blocklist.de/lists/all.txt" \
            -o /tmp/blocklist_de.txt 2>/dev/null || true
          if [ -s /tmp/blocklist_de.txt ]; then
            grep -v '^#' /tmp/blocklist_de.txt | grep -v '^$' | sort -u > sources/ioc/ips/blocklist_de.txt
            echo "Blocklist.de IPs: $(wc -l < sources/ioc/ips/blocklist_de.txt)"
          fi

      - name: Fetch AlienVault OTX (optional)
        if: ${{ env.OTX_API_KEY != '' }}
        env:
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}
        run: |
          # Fetch recent pulses (last 24h)
          curl -sSfL --retry 3 --max-time 120 \
            -H "X-OTX-API-KEY: ${OTX_API_KEY}" \
            "https://otx.alienvault.com/api/v1/pulses/subscribed?modified_since=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%S)" \
            -o /tmp/otx_pulses.json
          # Extract indicators by type
          python3 -c "
          import json, sys
          data = json.load(open('/tmp/otx_pulses.json'))
          hashes, domains, ips = set(), set(), set()
          for pulse in data.get('results', []):
              for ind in pulse.get('indicators', []):
                  t = ind.get('type', '')
                  v = ind.get('indicator', '')
                  if t in ('FileHash-SHA256',): hashes.add(v)
                  elif t in ('domain', 'hostname'): domains.add(v)
                  elif t in ('IPv4',): ips.add(v)
          open('sources/ioc/hashes/otx.txt', 'w').write('\n'.join(sorted(hashes)))
          open('sources/ioc/domains/otx.txt', 'w').write('\n'.join(sorted(domains)))
          open('sources/ioc/ips/otx.txt', 'w').write('\n'.join(sorted(ips)))
          "

      - name: Deduplicate IOCs
        run: |
          python threat-intel/processing/ioc_dedup.py \
            --input sources/ioc \
            --output /tmp/ioc_deduped

      - name: Apply allowlists
        run: |
          python threat-intel/processing/ioc_allowlist.py \
            --input /tmp/ioc_deduped \
            --output sources/ioc/consolidated \
            --hash-allowlist threat-intel/allowlists/known_good_hashes.txt \
            --domain-allowlist threat-intel/allowlists/known_good_domains.txt

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add sources/ioc/
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore(threat-intel): update IOC feeds $(date -u +%Y-%m-%dT%H:%M)"
          for i in 1 2 3; do
            git pull --rebase origin "${GITHUB_REF_NAME}" && git push && exit 0
            echo "Push attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "Failed to push after 3 attempts"
          exit 1
