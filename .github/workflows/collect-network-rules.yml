name: Collect Network Detection Rules

on:
  schedule:
    - cron: "30 3 * * *"  # Daily at 03:30 UTC
  workflow_dispatch:

permissions:
  contents: read

jobs:
  collect-suricata:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Suricata Emerging Threats Open ──────────────────────────────
      # 30,000+ network IDS rules maintained by Proofpoint.
      # Covers: malware C2, exploits, policy violations, protocol
      # anomalies, phishing, DNS tunneling, lateral movement.
      # BSD license — free for all use.
      - name: Download ET Open Suricata rules
        run: |
          mkdir -p /tmp/suricata
          curl -sSfL --retry 3 --max-time 300 \
            -o /tmp/et-open.tar.gz \
            "https://rules.emergingthreats.net/open/suricata-7.0/emerging.rules.tar.gz"
          tar xzf /tmp/et-open.tar.gz -C /tmp/suricata
          RULE_COUNT=$(grep -rc '^alert ' /tmp/suricata/rules/ 2>/dev/null | awk -F: '{s+=$2} END {print s}')
          FILE_COUNT=$(find /tmp/suricata/rules -name '*.rules' | wc -l)
          echo "Suricata ET Open: ${FILE_COUNT} rule files, ${RULE_COUNT} alert rules"

      # ── Filter for server/Linux-relevant categories ────────────────
      - name: Filter relevant Suricata categories
        run: |
          mkdir -p /tmp/suricata_filtered
          # Keep categories relevant to Linux servers and NAC
          KEEP_PATTERNS=(
            "emerging-malware"
            "emerging-trojan"
            "emerging-exploit"
            "emerging-attack_response"
            "emerging-scan"
            "emerging-dos"
            "emerging-dns"
            "emerging-rpc"
            "emerging-ftp"
            "emerging-smtp"
            "emerging-sql"
            "emerging-web_server"
            "emerging-web_specific_apps"
            "emerging-worm"
            "emerging-shellcode"
            "emerging-policy"
            "emerging-ciarmy"
            "emerging-compromised"
            "emerging-drop"
            "emerging-dshield"
            "emerging-botcc"
            "emerging-hunting"
            "emerging-phishing"
            "emerging-info"
            "emerging-ja3"
            "emerging-current_events"
            "emerging-misc"
            "emerging-mobile_malware"
            "emerging-netbios"
            "emerging-p2p"
            "emerging-snmp"
            "emerging-tftp"
            "emerging-voip"
          )
          for pattern in "${KEEP_PATTERNS[@]}"; do
            for f in /tmp/suricata/rules/${pattern}*.rules; do
              [ -f "$f" ] && cp "$f" /tmp/suricata_filtered/
            done
          done
          KEPT=$(grep -rc '^alert ' /tmp/suricata_filtered/ 2>/dev/null | awk -F: '{s+=$2} END {print s}')
          echo "Suricata filtered: ${KEPT} alert rules kept"

      - name: Upload Suricata rules as artifact
        uses: actions/upload-artifact@v4
        with:
          name: suricata-collected
          path: /tmp/suricata_filtered/
          retention-days: 7
