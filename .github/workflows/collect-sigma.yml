name: Collect SIGMA Rules

on:
  schedule:
    - cron: "0 2 * * *"  # Daily at 02:00 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: collect-sigma-${{ github.ref }}
  cancel-in-progress: true

jobs:
  collect-sigma:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Source 1: SigmaHQ ──────────────────────────────────────────
      # The canonical SIGMA repository (3000+ rules).
      # We process rules/, rules-emerging-threats/, and rules-threat-hunting/.
      - name: Clone SigmaHQ
        run: git clone --depth 1 https://github.com/SigmaHQ/sigma.git /tmp/sigma

      # ── Source 2: mdecrevoisier advanced correlation rules ─────────
      # 350+ advanced detection rules mapped to MITRE ATT&CK.
      # Complements SigmaHQ with correlation-based detections.
      - name: Clone mdecrevoisier SIGMA rules
        run: git clone --depth 1 https://github.com/mdecrevoisier/SIGMA-detection-rules.git /tmp/mdecrevoisier

      # ── Source 3: SOCFortress community rules ────────────────────
      # 500+ rules with strong MITRE ATT&CK mapping.
      # Cloud-native and endpoint anomaly detections.
      - name: Clone SOCFortress SIGMA rules
        run: git clone --depth 1 https://github.com/socfortress/Sigma-Rules.git /tmp/socfortress

      # ── Source 4: Splunk Security Content ────────────────────────
      # 400+ Sigma-format rules from Splunk's detection research team.
      # Enterprise-grade endpoint and network detections.
      - name: Clone Splunk Security Content
        run: git clone --depth 1 https://github.com/splunk/security_content.git /tmp/splunk

      # ── Source 5: Nextron APT detection rules ────────────────────
      # High-precision rules focused on APT/targeted threat hunting.
      - name: Clone Nextron detection rules
        run: git clone --depth 1 https://github.com/SigmaHQ/sigma-misc.git /tmp/sigma-misc 2>/dev/null || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: pip install pyyaml

      - name: Filter SIGMA rules
        run: |
          # Prepare Splunk sigma rules (nested under detections/sigma/)
          SPLUNK_SIGMA="/tmp/splunk/detections"
          if [ ! -d "${SPLUNK_SIGMA}" ]; then
            SPLUNK_SIGMA="/tmp/splunk"
          fi

          python threat-intel/processing/sigma_filter.py \
            --input /tmp/sigma/rules \
            --input /tmp/sigma/rules-emerging-threats \
            --input /tmp/sigma/rules-threat-hunting \
            --input /tmp/mdecrevoisier \
            --input /tmp/socfortress \
            --input "${SPLUNK_SIGMA}" \
            --input /tmp/sigma-misc \
            --output /tmp/sigma_filtered \
            --platforms linux \
            --min-status test

      - name: Enforce SIGMA collector coverage
        env:
          EGUARD_MIN_SIGMA_FILTERED: "150"
          EGUARD_REQUIRED_SIGMA_SOURCES: "rules,rules-emerging-threats,rules-threat-hunting"
        run: |
          python3 - <<'PY'
          import os
          import pathlib
          import sys

          root = pathlib.Path('/tmp/sigma_filtered')
          minimum = int(os.environ.get('EGUARD_MIN_SIGMA_FILTERED', '150'))
          required_sources = [
              s.strip() for s in os.environ.get('EGUARD_REQUIRED_SIGMA_SOURCES', '').split(',') if s.strip()
          ]

          total = sum(1 for _ in root.rglob('*.yml')) + sum(1 for _ in root.rglob('*.yaml'))
          print(f'total filtered sigma rules: {total}')

          failures = []
          if total < minimum:
              failures.append(f'sigma_count too low: {total} < {minimum}')

          for source in required_sources:
              src_dir = root / source
              src_total = 0
              if src_dir.is_dir():
                  src_total = sum(1 for _ in src_dir.rglob('*.yml')) + sum(1 for _ in src_dir.rglob('*.yaml'))
              print(f'source {source}: {src_total}')
              if src_total <= 0:
                  failures.append(f'missing sigma source coverage: {source}')

          if failures:
              print('sigma collector coverage gate failed:')
              for failure in failures:
                  print(f'- {failure}')
              sys.exit(1)

          print('sigma collector coverage gate passed')
          PY

      - name: Upload filtered rules as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sigma-filtered
          path: /tmp/sigma_filtered/
          retention-days: 7
