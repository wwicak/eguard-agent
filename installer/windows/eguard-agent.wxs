<?xml version="1.0" encoding="UTF-8"?>
<!-- AgentVersion is set via CLI: wix build -d AgentVersion=x.y.z -->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package
      Name="eGuard Endpoint Security Agent"
      Manufacturer="eGuard"
      Version="$(var.AgentVersion)"
      UpgradeCode="6D7F74EE-4F2E-4B90-BB77-9D1B8E4E8A11"
      InstallerVersion="500"
      Compressed="yes"
      Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version of eGuard Agent is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Property Id="ENROLLMENT_TOKEN" Secure="yes" />
    <Property Id="SERVER_URL" Secure="yes" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="eGuard" />
    </StandardDirectory>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="EGUARDDATA" Name="eGuard">
        <Directory Id="EGUARDCERTS" Name="certs" />
        <Directory Id="EGUARDRULES" Name="rules-staging" />
        <Directory Id="EGUARDQUAR" Name="quarantine" />
        <Directory Id="EGUARDLOGS" Name="logs" />
      </Directory>
    </StandardDirectory>

    <Feature Id="MainFeature" Title="eGuard Agent" Level="1">
      <ComponentGroupRef Id="AgentComponents" />
      <ComponentGroupRef Id="DataFolders" />
    </Feature>
  </Package>

  <Fragment>
    <ComponentGroup Id="AgentComponents" Directory="INSTALLFOLDER">
      <Component Id="CmpAgentExe" Guid="*">
        <File Id="FilAgentExe" Source="$(var.AgentExePath)" KeyPath="yes" />

        <ServiceInstall
            Id="SvcInstall"
            Name="eGuardAgent"
            DisplayName="eGuard Endpoint Security Agent"
            Description="eGuard EDR/MDM endpoint security agent"
            Type="ownProcess"
            Start="auto"
            ErrorControl="normal"
            Account="LocalSystem" />

        <ServiceControl Id="SvcStart" Name="eGuardAgent" Start="install" Stop="both" Remove="uninstall" Wait="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="DataFolders" Directory="EGUARDDATA">
      <Component Id="CmpDataRoot" Guid="A1B2C3D4-E5F6-4A7B-8C9D-0E1F2A3B4C5D">
        <CreateFolder />
      </Component>
      <Component Id="CmpDataCerts" Guid="B2C3D4E5-F6A7-4B8C-9D0E-1F2A3B4C5D6E" Directory="EGUARDCERTS">
        <CreateFolder />
      </Component>
      <Component Id="CmpDataRules" Guid="C3D4E5F6-A7B8-4C9D-0E1F-2A3B4C5D6E7F" Directory="EGUARDRULES">
        <CreateFolder />
      </Component>
      <Component Id="CmpDataQuarantine" Guid="D4E5F6A7-B8C9-4D0E-1F2A-3B4C5D6E7F80" Directory="EGUARDQUAR">
        <CreateFolder />
      </Component>
      <Component Id="CmpDataLogs" Guid="E5F6A7B8-C9D0-4E1F-2A3B-4C5D6E7F8091" Directory="EGUARDLOGS">
        <CreateFolder />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
