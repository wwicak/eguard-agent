syntax = "proto3";

package eguard.v1;

option go_package = "gitlab.com/devaistech77/fe_eguard/go/api/agent/v1;agentv1";

service TelemetryService {
  rpc SendEvent(TelemetryEvent) returns (TelemetryAck);
  rpc StreamEvents(stream TelemetryBatch) returns (stream EventAck);
  rpc ReportInventory(InventoryReport) returns (InventoryAck);
}

enum EventType {
  PROCESS_EXEC = 0;
  FILE_OPEN = 1;
  TCP_CONNECT = 2;
  DNS_QUERY = 3;
  MODULE_LOAD = 4;
  USER_LOGIN = 5;
  ALERT = 6;
}

enum Severity {
  INFO = 0;
  LOW = 1;
  MEDIUM = 2;
  HIGH = 3;
  CRITICAL = 4;
}

message ProcessExecEvent {
  string exe_path = 1;
  string cmdline = 2;
  string sha256 = 3;
  string cgroup_id = 4;
  repeated string ancestors = 5;
}

message TelemetryEvent {
  string event_id = 1;
  EventType event_type = 2;
  Severity severity = 3;
  int64 timestamp = 4;
  int64 pid = 5;
  int64 ppid = 6;
  int64 uid = 7;
  string comm = 8;
  string parent_comm = 9;

  // Legacy/compatibility fields retained for current client payloads.
  string agent_id = 20;
  string rule_name = 21;
  string payload_json = 22;
  map<string, string> labels = 23;
  int64 created_at_unix = 24;

  oneof detail {
    ProcessExecEvent process_exec = 30;
  }
}

message TelemetryBatch {
  string agent_id = 1;
  repeated TelemetryEvent events = 2;
  bool compressed = 3;
  bytes events_compressed = 4;
}

message EventAck {
  int64 last_event_offset = 1;
  int64 events_accepted = 2;
}

message InventoryReport {
  string agent_id = 1;
  string os_type = 2;
  string os_version = 3;
  string kernel_version = 4;
  string hostname = 5;
  string device_model = 6;
  string device_serial = 7;
  string user = 8;
  string ownership = 9;
  bool disk_encrypted = 10;
  bool jailbreak_detected = 11;
  bool root_detected = 12;
  string mac = 13;
  string ip_address = 14;
  int64 collected_at_unix = 15;
  map<string, string> attributes = 16;
}

message InventoryAck {
  string status = 1;
  int32 next_report_override_secs = 2;
}

message TelemetryAck {
  string status = 1;
}

message TelemetryStreamAck {
  string status = 1;
  int64 accepted_count = 2;
}
