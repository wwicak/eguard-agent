FROM rust:1.88-bookworm AS builder
RUN apt-get update && apt-get install -y --no-install-recommends \
    clang llvm libbpf-dev linux-headers-amd64 ca-certificates curl python3 git xz-utils \
    && rm -rf /var/lib/apt/lists/*
RUN curl -fsSL https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz \
    | tar -xJ -C /opt \
    && ln -sf /opt/zig-linux-x86_64-0.13.0/zig /usr/local/bin/zig
WORKDIR /workspace
COPY . .
RUN cargo build --release
RUN cargo test --no-run

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends \
    procps iproute2 curl python3 netcat-openbsd strace ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /usr/local/bin
COPY --from=builder /workspace/target/release/agent-core /usr/local/bin/eguard-agent
COPY --from=builder /workspace/tests /usr/local/bin/tests
CMD ["/usr/local/bin/tests/run-all.sh"]
