services:
  eguard-server:
    build:
      context: ..
      dockerfile: tests/Dockerfile.runtime
    environment:
      EGUARD_TEST_MODE: "1"
    ports:
      - "50052:50052"
      - "9999:9999"

  agent-test:
    build:
      context: ..
      dockerfile: tests/Dockerfile.agent-test
    privileged: true
    cap_add:
      - SYS_ADMIN
      - BPF
      - NET_ADMIN
    environment:
      EGUARD_SERVER: eguard-server:50052
      ENROLLMENT_TOKEN: test-token-12345
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/fs/bpf:/sys/fs/bpf

  malware-simulator:
    build:
      context: ..
      dockerfile: tests/Dockerfile.runtime
    network_mode: "service:agent-test"

