#!/bin/sh
set -e

mkdir -p /tmp

cat > /tmp/replay.ndjson <<'EOF'
{"event_type":"process_exec","pid":6000,"ppid":1,"uid":1000,"ts_ns":100000,"comm":"gdb","path":"/usr/bin/gdb","cmdline":"gdb --pid 4242 --eval-command=ptrace"}
{"event_type":"process_exec","pid":6001,"ppid":6000,"uid":1000,"ts_ns":200000,"comm":"bash","path":"memfd:payload (deleted)","cmdline":"memfd:payload"}
{"event_type":"process_exec","pid":7000,"ppid":1,"uid":1000,"ts_ns":300000,"comm":"python","path":"/usr/bin/python","cmdline":"python userfaultfd_poc.py"}
{"event_type":"process_exec","pid":7001,"ppid":7000,"uid":1000,"ts_ns":400000,"comm":"payload","path":"/proc/self/fd/7","cmdline":"execveat /proc/self/fd/7"}
{"event_type":"file_open","pid":8000,"ppid":1,"uid":1000,"ts_ns":500000,"file_path":"/proc/4242/mem","flags":0,"mode":0}
{"event_type":"process_exec","pid":8001,"ppid":8000,"uid":1000,"ts_ns":600000,"comm":"bash","path":"memfd:stage (deleted)","cmdline":"memfd:stage"}
EOF

export EGUARD_EBPF_REPLAY_PATH=/tmp/replay.ndjson
export EGUARD_AUTONOMOUS_RESPONSE=false
export EGUARD_BASELINE_SKIP_LEARNING=1
export EGUARD_AGENT_MODE=degraded
export EGUARD_TRANSPORT_MODE=http
export EGUARD_SERVER_ADDR=127.0.0.1:9
export EGUARD_BUFFER_BACKEND=memory
export EGUARD_SELF_PROTECT_ENABLE_TIMING=0
export EGUARD_SELF_PROTECT_ENABLE_TRACER_PID=0
export EGUARD_SELF_PROTECTION_INTEGRITY_CHECK_INTERVAL_SECS=0
export EGUARD_SELF_PROTECT_LAZY_BASELINE=1
export EGUARD_DEBUG_EVENT_LOG=1
export EGUARD_DEBUG_REPLAY_LOG=1
export RUST_LOG=info
export RUST_LOG_STYLE=never
export NO_COLOR=1

/payload/bin/agent-core >/tmp/agent.log 2>&1 &
agent_pid=$!

sleep 20

if ! kill -0 "$agent_pid" 2>/dev/null; then
  echo "agent exited before exploit chain replay" >&2
  echo "--- replay file ---" >&2
  cat /tmp/replay.ndjson >&2 || true
  echo "--- agent log ---" >&2
  cat /tmp/agent.log >&2 || true
  exit 1
fi

for marker in killchain_exploit_ptrace_fileless killchain_exploit_userfaultfd_execveat killchain_exploit_proc_mem_fileless; do
  if ! grep -Fq "$marker" /tmp/agent.log; then
    echo "missing exploit chain marker $marker" >&2
    echo "--- agent log ---" >&2
    cat /tmp/agent.log >&2 || true
    kill "$agent_pid" 2>/dev/null || true
    exit 1
  fi
done

kill "$agent_pid" 2>/dev/null || true
wait "$agent_pid" 2>/dev/null || true

echo "agent exploit chain harness ok"
