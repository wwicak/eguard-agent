#!/bin/sh
set -e

mkdir -p /tmp/eguard-bundle/ioc /tmp/eguard-samples/malware /tmp/eguard-samples/benign

EICAR_STR='X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'

printf "%s" "$EICAR_STR" > /tmp/eguard-samples/malware/eicar.com

idx=1
while [ "$idx" -le 20 ]; do
  printf "%s\n%s" "$EICAR_STR" "sample-${idx}" > "/tmp/eguard-samples/malware/eicar-${idx}.com"
  idx=$((idx + 1))
done

cat <<'EOF' > /tmp/malware_urls.txt
xmrig-linux-static.tar.gz|https://github.com/xmrig/xmrig/releases/download/v6.21.2/xmrig-6.21.2-linux-static-x64.tar.gz
eicar_com.zip|https://secure.eicar.org/eicar_com.zip
eicar_com2.zip|https://secure.eicar.org/eicar_com2.zip
eicar.com|https://secure.eicar.org/eicar.com
eicar.com.txt|https://secure.eicar.org/eicar.com.txt
EOF

download_optional() {
  url="$1"
  dest="$2"
  if command -v curl >/dev/null 2>&1; then
    if curl -fsSL "$url" -o "$dest" >/tmp/curl.log 2>&1; then
      return 0
    fi
    echo "download failed: $url" >&2
    cat /tmp/curl.log >&2 || true
    return 1
  fi
  if wget -O "$dest" "$url" >/tmp/wget.log 2>&1; then
    return 0
  fi
  if wget --no-check-certificate -O "$dest" "$url" >/tmp/wget.log 2>&1; then
    return 0
  fi
  echo "download failed: $url" >&2
  cat /tmp/wget.log >&2 || true
  return 1
}

while IFS='|' read -r name url; do
  [ -z "$name" ] && continue
  dest="/tmp/eguard-samples/malware/$name"
  if download_optional "$url" "$dest"; then
    echo "$dest" >> /tmp/malware_downloaded.txt
  fi
done < /tmp/malware_urls.txt

mb_key="${MALWAREBAZAAR_API_KEY:-${MALWARE_BAZAAR_KEY:-}}"
if [ -n "$mb_key" ]; then
  echo "malwarebazaar key present" >&2
  cat <<'EOF' > /tmp/malwarebazaar_hashes.txt
0f0d6f9dc3b64c1aa97c4d4f6202c3e9ed83ad2053c7d115f257b2502ea3f7a1
6b7c0e1cc35d9d7397d0c5a3f3d14ec2b2d0ec9a9f5d0c4e8f2c64b1a7219cda
90f7c3d2e85ad7e00a8c96dd71f8a1dc2b63a5460e0b2c5bfbd9a8f4a1d90df2
7e6b0adf9e3a7e2a9c9b7d84f1c2f1e0a9b8c7d6e5f4a3b2c1d0e9f8a7b6c5d4
5b4a3c2d1e0f9876543210fedcba9876543210fedcba9876543210fedcba9876
EOF

  while IFS= read -r hash; do
    [ -z "$hash" ] && continue
    dest="/tmp/eguard-samples/malware/mb-${hash}.zip"
    if command -v curl >/dev/null 2>&1; then
      http_code=$(curl -sSL -H "Auth-Key: ${mb_key}" \
        -d "query=get_file&sha256_hash=${hash}" \
        -o "$dest" -w "%{http_code}" https://mb-api.abuse.ch/api/v1/ 2>/tmp/curl.log || true)
      if [ "$http_code" = "200" ]; then
        echo "$dest" >> /tmp/malware_downloaded.txt
        continue
      fi
      echo "malwarebazaar download failed: $hash (HTTP ${http_code})" >&2
      cat /tmp/curl.log >&2 || true
      if [ -f "$dest" ]; then
        head -c 256 "$dest" >&2 || true
        rm -f "$dest"
      fi
      continue
    fi
    if wget --header "Auth-Key: ${mb_key}" \
      --post-data "query=get_file&sha256_hash=${hash}" \
      -O "$dest" https://mb-api.abuse.ch/api/v1/ >/tmp/wget.log 2>&1; then
      echo "$dest" >> /tmp/malware_downloaded.txt
    else
      echo "malwarebazaar download failed: $hash" >&2
      cat /tmp/wget.log >&2 || true
    fi
  done < /tmp/malwarebazaar_hashes.txt
fi

malware_list=/tmp/malware_files.txt
benign_list=/tmp/benign_files.txt
: > "$malware_list"

if [ -f /tmp/malware_downloaded.txt ]; then
  while IFS= read -r file; do
    [ -f "$file" ] || continue
    case "$file" in
      *.tar.gz)
        dest_dir="/tmp/eguard-samples/malware/$(basename "$file" .tar.gz)"
        mkdir -p "$dest_dir"
        tar -xzf "$file" -C "$dest_dir" >/dev/null 2>&1 || true
        ;;
      *.zip)
        dest_dir="/tmp/eguard-samples/malware/$(basename "$file" .zip)"
        mkdir -p "$dest_dir"
        unzip -P infected -o "$file" -d "$dest_dir" >/dev/null 2>&1 || unzip -o "$file" -d "$dest_dir" >/dev/null 2>&1 || true
        ;;
    esac
  done < /tmp/malware_downloaded.txt
fi

for file in /tmp/eguard-samples/malware/*; do
  [ -f "$file" ] || continue
  echo "$file" >> "$malware_list"
done
for file in /tmp/eguard-samples/malware/*/*; do
  [ -f "$file" ] || continue
  echo "$file" >> "$malware_list"
done

malware_total=$(wc -l < "$malware_list" | awk '{print $1}')
if [ "$malware_total" -lt 20 ]; then
  echo "malware sample count too low: $malware_total" >&2
  exit 1
fi

if [ ! -f /tmp/malware_downloaded.txt ]; then
  echo "no external malware downloads completed" >&2
  exit 1
fi
if [ "$(wc -l < /tmp/malware_downloaded.txt | awk '{print $1}')" -lt 1 ]; then
  echo "external malware download count too low" >&2
  exit 1
fi

: > "$benign_list"
benign_idx=1
while [ "$benign_idx" -le 50 ]; do
  benign_path="/tmp/eguard-samples/benign/benign-${benign_idx}.txt"
  printf "eguard benign sample %s\n" "$benign_idx" > "$benign_path"
  echo "$benign_path" >> "$benign_list"
  benign_idx=$((benign_idx + 1))
done

: > /tmp/eguard-bundle/ioc/hashes.txt
while IFS= read -r file; do
  hash=$(sha256sum "$file" | awk '{print $1}')
  if [ -n "$hash" ]; then
    echo "$hash" >> /tmp/eguard-bundle/ioc/hashes.txt
  fi
done < "$malware_list"

/bin/busybox sleep 30 >/dev/null 2>&1 &
sample_pid=$!

: > /tmp/replay.ndjson
counter=1
while IFS= read -r file; do
  printf '{"event_type":"file_open","pid":%s,"uid":0,"ts_ns":%s,"file_path":"%s","flags":0,"mode":0}\n' \
    "$sample_pid" "$((counter * 1000000))" "$file" >> /tmp/replay.ndjson
  counter=$((counter + 1))
done < "$malware_list"

while IFS= read -r file; do
  printf '{"event_type":"file_open","pid":%s,"uid":0,"ts_ns":%s,"file_path":"%s","flags":0,"mode":0}\n' \
    "$sample_pid" "$((counter * 1000000))" "$file" >> /tmp/replay.ndjson
  counter=$((counter + 1))
done < "$benign_list"

export EGUARD_BUNDLE_PATH=/tmp/eguard-bundle
export EGUARD_AUTONOMOUS_RESPONSE=false
export EGUARD_BASELINE_SKIP_LEARNING=1
export EGUARD_AGENT_MODE=degraded
export EGUARD_TRANSPORT_MODE=http
export EGUARD_SERVER_ADDR=127.0.0.1:9
export EGUARD_EBPF_REPLAY_PATH=/tmp/replay.ndjson
export EGUARD_SELF_PROTECT_ENABLE_TIMING=0
export EGUARD_SELF_PROTECT_ENABLE_TRACER_PID=0
export EGUARD_DEBUG_EVENT_LOG=1
export RUST_LOG=info
export RUST_LOG_STYLE=never
export NO_COLOR=1

/payload/bin/agent-core >/tmp/agent.log 2>&1 &
agent_pid=$!

sleep 25

malware_detected=0
while IFS= read -r file; do
  if grep -F "file_path=Some(\"$file\")" /tmp/agent.log | grep -q "confidence=Definite"; then
    malware_detected=$((malware_detected + 1))
  fi
done < "$malware_list"

benign_detected=0
while IFS= read -r file; do
  if grep -F "file_path=Some(\"$file\")" /tmp/agent.log | grep -qv "confidence=None"; then
    benign_detected=$((benign_detected + 1))
  fi
done < "$benign_list"

benign_total=$(wc -l < "$benign_list" | awk '{print $1}')
if [ "$benign_total" -eq 0 ]; then
  echo "benign sample count missing" >&2
  exit 1
fi

malware_total=$(wc -l < "$malware_list" | awk '{print $1}')
if [ "$malware_total" -eq 0 ]; then
  echo "malware sample count missing" >&2
  exit 1
fi

tpr_pct=$((malware_detected * 100 / malware_total))
fpr_pct=$((benign_detected * 100 / benign_total))

cat > /tmp/malware_metrics.json <<EOF
{"malware_total":$malware_total,"malware_detected":$malware_detected,"benign_total":$benign_total,"benign_detected":$benign_detected,"tpr_pct":$tpr_pct,"fpr_pct":$fpr_pct}
EOF

echo "TPR=${tpr_pct}% FPR=${fpr_pct}%" >&2

if [ "$tpr_pct" -lt 80 ] || [ "$benign_detected" -ne 0 ]; then
  echo "malware detection thresholds not met" >&2
  echo "--- agent log ---" >&2
  cat /tmp/agent.log >&2 || true
  kill "$agent_pid" 2>/dev/null || true
  kill "$sample_pid" 2>/dev/null || true
  exit 1
fi

kill "$agent_pid" 2>/dev/null || true
wait "$agent_pid" 2>/dev/null || true
kill "$sample_pid" 2>/dev/null || true

echo "agent malware harness ok"
